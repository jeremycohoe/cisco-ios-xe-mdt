# Telegraf Configuration for Cisco IOS XE gNMI Telemetry
# Author: Jeremy Cohoe
# Description: Basic configuration with OpenConfig and Cisco Native YANG models
# Device: Cisco Catalyst 9300 running IOS XE 17.15.1
# Updated: November 2025

# Global Agent Configuration
[agent]
  interval = "10s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "10s"
  flush_jitter = "0s"
  precision = "0s"
  hostname = ""
  omit_hostname = false

# Output Configuration - Write to file
[[outputs.file]]
  files = ["/tmp/telegraf-gnmi-output.log"]
  data_format = "influx"

# Output Configuration - Display to stdout for monitoring
[[outputs.file]]
  files = ["stdout"]
  data_format = "influx"

###############################################################################
# INPUT PLUGINS - gNMI (GNMI Network Management Interface)
###############################################################################

# Combined gNMI Input - OpenConfig and Cisco Native YANG models
[[inputs.gnmi]]
  ## Address and port of the gNMI server
  addresses = ["10.85.134.65:9339"]

  ## Authentication credentials
  username = "admin"
  password = "password"

  ## Redial on TCP disconnect (important for long-running connections)
  redial = "10s"

  ## Enable TLS but skip certificate verification (for lab environments)
  ## Production environments should use proper certificates
  tls_enable = true
  insecure_skip_verify = true

  ## Encoding type for gNMI messages
  ## Options: json_ietf, proto, bytes
  encoding = "json_ietf"

  ## OpenConfig Interface Counters
  [[inputs.gnmi.subscription]]
    name = "oc_interface_counters"
    origin = "openconfig"
    path = "/interfaces/interface/state/counters"
    subscription_mode = "sample"
    sample_interval = "10s"

  ## OpenConfig Platform - Hardware components, fans, power supplies
  [[inputs.gnmi.subscription]]
    name = "oc_platform"
    origin = "openconfig"
    path = "/components"
    subscription_mode = "sample"
    sample_interval = "15s"

  ## OpenConfig System - System information and uptime
  [[inputs.gnmi.subscription]]
    name = "oc_system"
    origin = "openconfig"
    path = "/system"
    subscription_mode = "sample"
    sample_interval = "20s"

  ## Cisco Native - CPU Usage (per-process CPU utilization)
  ## CRITICAL: Use origin="legacy" for Cisco Native YANG models
  ## Telegraf lowercases the origin field, so use lowercase module names
  [[inputs.gnmi.subscription]]
    name = "cpu_usage"
    origin = "legacy"
    path = "/process-cpu-ios-xe-oper:cpu-usage/cpu-utilization"
    subscription_mode = "sample"
    sample_interval = "10s"

  ## Cisco Native - Memory Statistics (system memory pool usage)
  [[inputs.gnmi.subscription]]
    name = "memory_stats"
    origin = "legacy"
    path = "/memory-ios-xe-oper:memory-statistics/memory-statistic"
    subscription_mode = "sample"
    sample_interval = "10s"

  ## Additional tags to add to all metrics from this input
  [inputs.gnmi.tags]
    source = "10.85.134.65"
    device_type = "c9300"
    site = "lab"
